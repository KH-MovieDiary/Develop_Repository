<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="reviewMapper">
 
 <insert id="reviewInsert" parameterType="Review">
 	INSERT INTO REVIEW
 	VALUES(SEQ_RENO.NEXTVAL
 		   ,#{content}
 		   ,SYSDATE
 		   ,NULL
 		   ,0
 		   ,0
 		   ,#{movieId}
		   ,#{userId}
		   ,#{reviewTitle}
		   )
 </insert>
 
 <update id="increaseCount">
 	UPDATE REVIEW
 	SET VIEW_COUNT=VIEW_COUNT+1
 	WHERE REVIEW_ID=#{rno}
 </update>
 
 <select id="reviewDetail" resultType="Review">
 	SELECT REVIEW_ID,
 		   CONTENT,
 		   R.CREATE_DATE,
 		   VIEW_COUNT,
 		   LIKE_COUNT,
 		   (SELECT MOVIE_TITLE 
            FROM MOVIE M 
            WHERE M.MOVIE_ID = R.MOVIE_ID) movieTitle
 		   ,USER_ID
 		   ,REVIEW_TITLE
 		   ,R.UPDATE_DATE
 		   ,NICKNAME
 	FROM REVIEW R
 	JOIN MEMBER M USING(USER_ID)
 	WHERE REVIEW_ID=#{rno}
 </select>
 
 <update id="reviewUpdate" parameterType="Review">
 	UPDATE REVIEW
 	SET CONTENT = #{content},
 		REVIEW_TITLE = #{reviewTitle},
 		UPDATE_DATE = SYSDATE
	WHERE REVIEW_ID = #{reviewId}
 </update>
 
 <delete id="reviewDelete">
 	DELETE FROM REVIEW
 	WHERE REVIEW_ID = #{rno}
 </delete>
 
 <select id="listCount" resultType="_int">
 	SELECT COUNT(*)
 	FROM REVIEW
 </select>
 
 <select id="reviewList" resultType="ReviewList">
 	SELECT REVIEW_ID
 		  ,MOVIE_ID
 		  ,NICKNAME
 		  ,VIEW_COUNT
 		  ,LIKE_COUNT
 		  ,R.CREATE_DATE
 		  ,REVIEW_TITLE
 	FROM REVIEW R
 	JOIN MEMBER M USING(USER_ID)
 	<choose>
 		<when test="sort == 'date'">
 			ORDER BY R.CREATE_DATE DESC
 		</when>
 		<when test="sort == 'count'">
 			ORDER BY VIEW_COUNT DESC
 		</when>
 		<otherwise>
 			ORDER BY LIKE_COUNT DESC
 		</otherwise>
 	</choose>
 </select>
 
 <select id="reviewLike" parameterType="Reviewlike" resultType="string">
 	SELECT LIKE_YN
    FROM REVIEW_LIKE
    WHERE REVIEW_ID = #{reviewId}
       	  AND USER_ID = #{userId}
 </select>
 
 <insert id="likeInsert" parameterType="Reviewlike">
 	INSERT INTO REVIEW_LIKE
 	VALUES(#{reviewId}
 		  ,#{userId}
 		  ,'Y'
 		  )
 </insert>
 
 <update id="likeUpdate" parameterType="Reviewlike">
 	UPDATE REVIEW_LIKE
 	SET LIKE_YN = DECODE(LIKE_YN, 'Y', 'N', 'Y')
    WHERE REVIEW_ID = #{reviewId}
         AND USER_ID = #{userId}
 </update>
 
 <select id="searchList" resultType="ReviewList">
 	SELECT REVIEW_ID
 		  ,MOVIE_ID
 		  ,NICKNAME
 		  ,VIEW_COUNT
 		  ,LIKE_COUNT
 		  ,R.CREATE_DATE
 		  ,REVIEW_TITLE
 	FROM REVIEW R
 	JOIN MEMBER M USING(USER_ID)
 	<choose>
 		<when test="condition == 'title'">
 			WHERE REVIEW_TITLE LIKE '%'||#{keyword}||'%'
 		</when>
		<otherwise>
			WHERE NICKNAME = #{keyword}
		</otherwise>
 	</choose>
 	
 	<choose>
 		<when test="sort == 'count'">
 			ORDER BY LIKE_COUNT DESC
 		</when>
 		<when test="sort == 'count'">
 			ORDER BY VIEW_COUNT DESC
 		</when>
 		<otherwise>
 			ORDER BY R.CREATE_DATE DESC
 		</otherwise>
 	</choose>
 </select>
   
 <select id="searchListCount" resultType="_int">
 	SELECT COUNT(*)
 	FROM REVIEW
 	JOIN MEMBER M USING(USER_ID)
 	<choose>
 		<when test="condition == 'title'">
 			WHERE REVIEW_TITLE LIKE '%'||#{keyword}||'%'
 		</when>
		<otherwise>
			WHERE NICKNAME = #{keyword}
		</otherwise>
 	</choose>
 </select>  
 
 <select id="selectList" parameterType="int" resultType="ReviewComment">
 	SELECT NICKNAME
 		  ,CONTENT
 		  ,R.CREATE_DATE
 	FROM REVIEW_COMMENT R
 	JOIN MEMBER M USING(USER_ID)
 	WHERE REVIEW_ID = #{reviewId}
 	ORDER BY R.CREATE_DATE DESC
 </select>
   
 <insert id="insertReply" parameterType="ReviewComment">
 	 INSERT INTO REVIEW_COMMENT(
        REVIEW_COMMENT_ID,
        CREATE_DATE,
        UPDATE_DATE,
        CONTENT,
        REVIEW_ID,
        USER_ID)
    VALUES(
        SEQ_RCNO.NEXTVAL,
        SYSDATE,
        SYSDATE,
        #{content},
        #{reviewId},
        #{userId})
 </insert>

</mapper>

